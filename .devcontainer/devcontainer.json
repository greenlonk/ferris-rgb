{
  "name": "Nix-backed Rust Env",
  "dockerFile": "Dockerfile",
  "features": {
    // 1. Install Nix (Single-user mode is usually fine for containers)
    "ghcr.io/devcontainers/features/nix:1": {
      "version": "latest",
      "multiUser": false
    },
    // 2. Common utilities including Zsh
    "ghcr.io/devcontainers/features/common-utils:2": {
      "configureZshAsDefaultShell": true
    }
  },
  "containerEnv": {
    "NIX_CONFIG": "extra-experimental-features = nix-command flakes"
  },
  // 3. Automation: Set up Direnv to trust the flake immediately
  "postCreateCommand": [
    "/bin/zsh",
    "-c",
    "echo 'eval \"$(direnv hook zsh)\"' >> ~/.zshrc && direnv allow"
  ],
  "customizations": {
    "jetbrains": {
      "settings": {
        "com.intellij:app:BuiltInServerOptions.builtInServerPort": 59607,
        "com.intellij:app:HttpConfigurable.use_proxy_pac": true
      },
      "plugins": [
        "systems.fehn.intellijdirenv",
        "com.jetbrains.rust",
        "org.toml.lang",
        "nix-idea"
      ]
    },
    "vscode": {
      "extensions": [
        "rust-lang.rust-analyzer",
        "jnoortheen.nix-ide",
        "tamasfe.even-better-toml"
      ],
      "settings": {
        "terminal.integrated.defaultProfile.linux": "zsh",
        "editor.fontFamily": "JetBrains Mono, monospace",
        "terminal.integrated.fontFamily": "JetBrains Mono"
      }
    }
  },
  // 4. Permissions: Nix often needs privileges for /nix/store operations
  "runArgs": [
    "--privileged"
  ],
  // 5. Mount the nix store (Optional: caching optimization)
  // If you want to persist the nix store between rebuilds to save time:
  "mounts": [
    "source=nix-store-volume,target=/nix,type=volume"
  ]
}