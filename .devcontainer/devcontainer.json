{
  "name": "Nix-backed Rust Env",
  "dockerFile": "Dockerfile",
  "features": {
    // 1. Install Nix (Single-user mode is usually fine for containers)
    "ghcr.io/devcontainers/features/nix:1": {
      "version": "latest",
      "multiUser": false
    },
    // 2. Common utilities including Zsh
    "ghcr.io/devcontainers/features/common-utils:2": {
      "configureZshAsDefaultShell": true
    }
  },
  "containerEnv": {
    "NIX_CONFIG": "extra-experimental-features = nix-command flakes"
  },
  // 3. Automation: Set up Direnv to trust the flake immediately
  "postCreateCommand": [
    "/bin/zsh",
    "-c",
    "echo 'eval \"$(direnv hook zsh)\"' >> ~/.zshrc && direnv allow"
  ],
  "customizations": {
    "jetbrains": {
      "settings": {
        "com.intellij:app:BuiltInServerOptions.builtInServerPort": 59607,
        "com.intellij:app:HttpConfigurable.use_proxy_pac": true
      },
      "plugins": [
        "systems.fehn.intellijdirenv",
        "com.jetbrains.rust",
        "org.toml.lang",
        "nix-idea"
      ]
    },
    "vscode": {
      "extensions": [
        "catppuccin.catppuccin-vsc",
        "rust-lang.rust-analyzer",
        "jnoortheen.nix-ide",
        "tamasfe.even-better-toml",
        "ms-azuretools.vscode-docker",
        "ardonplay.vscode-jetbrains-full-icon-theme",
        "zxchhh.jetbrains-dark-new-ui"
      ],
      "settings": {
        // Use zsh
        "terminal.integrated.defaultProfile.linux": "zsh",
        // VSCode isolation
        "remote.containers.copyExtensions": false,  // ‚Üê crucial
        "dev.containers.copyGitConfig": true,
        "remote.extensionKind": {
        "*": ["workspace"]  // force *all* extensions to run inside container only
        },
        // Fonts
        "editor.fontFamily": "JetBrains Mono, monospace",
        "editor.definitionLinkOpensInPeek": false,
        "editor.multipleCursorModifier": "alt",
        "editor.gotoLocation.multipleDefinitions": "goto",  
        "terminal.integrated.fontFamily": "JetBrains Mono",
        // Theme
        "workbench.colorTheme": "JetBrains Dark (New UI)",
        "workbench.iconTheme": "vscode-jetbrains-icon-theme-2023-auto",
        "editor.cursorSmoothCaretAnimation": "on",
        "editor.fontLigatures": true,
        "editor.fontSize": 14,
        "editor.lineHeight": 22,
        // Rust Analyzer config
        "rust-analyzer.rustc.source": "/workspaces/ferris-rgb/.sysroot/sysroot",
        "rust-analyzer.cargo.autoreload": true,
        "rust-analyzer.checkOnSave": true,
        "rust-analyzer.check.command": "clippy",
        "rust-analyzer.inlayHints.enable": true,
        "rust-analyzer.procMacro.enable": true,
        "rust-analyzer.navigate.mode": "goto",
        // Nix IDE config
        "nixIde.enableNixFmtOnSave": true,
        "nixIde.showNixPkgsCompletions": true,
        "nixIde.trace.server": "off",
        "nixIde.nixpkgsPath": "<nixpkgs>",
        "nixIde.flakeSupport": true,
        "nixIde.useNixEnv": true,
        "nixIde.enableNixLsp": true,
        "nixIde.nixLspPath": "nix-lsp",
        "nixIde.nixLspArgs": [],
        "nixIde.nixLspLogLevel": "info"
      }
    }
  },
  // 4. Permissions: Nix often needs privileges for /nix/store operations
  "runArgs": [
    "--privileged"
  ],
  // 5. Mount the nix store (Optional: caching optimization)
  // If you want to persist the nix store between rebuilds to save time:
  "mounts": [
    "source=nix-store-volume,target=/nix,type=volume"
  ]
}